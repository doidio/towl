# 血管吻合模拟 (Vascular Anastomosis Simulation)

本项目是一个生物医学工程工具，用于模拟血管吻合（即血管的外科手术连接）后的血流动力学。它利用医学影像数据创建血管的三维模型，执行虚拟手术连接，并运行计算流体动力学 (CFD) 模拟来分析其结果。

项目的主要目标可能是用于术前评估不同的手术方案，并预测其血流动力学效果。

## 功能特性

- **血管中心线提取**: 使用 `ITK` 库和高性能的 `Warp` 内核，从三维医学图像 (`.nii.gz` 格式) 中处理并提取血管的中心线和半径。

- **几何建模**:
    - 读取由 `3D Slicer` (VMTK 扩展) 等医学影像软件导出的中心线数据。
    - 通过三维变换执行虚拟的血管吻合，将不同的血管段（例如，肾动脉与髂内动脉）对齐并连接。
    - 使用有向距离场 (`SDF`) 和可微分行进立方体 (`Differentiable Marching Cubes`) 算法重建血管内壁的三维表面网格。

- **流体动力学模拟**:
    - 使用平滑粒子流体动力学 (`SPH`) 方法模拟血液流动。
    - 基于 `Warp` 构建的 `Newton` 物理引擎进行高性能计算。
    - 通过施加模拟的血压来驱动血流，并计算血管壁上的剪切应力 (shear stress)。

- **可视化**:
    - 使用 `PyVista` 提供模拟过程的实时三维可视化。
    - 渲染血流粒子和重建的血管网格。
    - 将最终模拟结果导出为 `movie.mp4` 视频文件。

##核心脚本

- `anastomosis.py`: 项目主入口，负责加载数据、血管几何对齐、运行 SPH 模拟和可视化。
- `centertree.py`: 用于从原始三维医学图像中提取中心线和几何特征。
- `kernel.py`: 包含使用 `Warp` 编写的核心计算内核，用于 SDF 计算、SPH 物理等。

## 如何运行

本项目通过一个 `.toml` 配置文件来驱动。

1.  **配置**:
    - 创建一个 `config.toml` 文件。
    - 在文件中指定中心线数据 (`.json` 文件) 的路径。
    - 定义需要连接的血管部分。
    - 设置血压、粒子大小、帧率等模拟参数。

2.  **执行**:
    ```bash
    python anastomosis.py path/to/your/config.toml
    ```

## 主要依赖

本项目依赖于一系列专业的科学计算和高性能计算库：

- **医学影像**: `itk`
- **三维图形与几何**: `pyvista`, `trimesh`, `vtk`
- **高性能计算**: `warp-lang`
- **物理模拟**: `newton-physics`
- **科学计算**: `numpy`, `scikit-learn`
- **配置**: `tomlkit`
